import React, { useState, useEffect } from 'react';
import { Card } from '../ui/Card';
import { FAB } from '../ui/FAB';
import { Modal } from '../ui/Modal';
import { Button } from '../ui/Button';
import { Input } from '../ui/Input';
import { useAuth } from '../../contexts/AuthContext';
import { formatCurrency } from '../../utils/helpers';
import { getTodayTotal, getWeekTotal, getMonthTotal, getTopCategory, getCategoryBreakdown, getTrendData, getPreviousWeekTotal, getPreviousMonthTotal } from '../../lib/db/expenseStore';
import { CategoryBreakdownChart } from '../charts/CategoryBreakdownChart';
import { SpendingTrendChart } from '../charts/SpendingTrendChart';
import { DatePickerInput } from '../ui/DatePicker';
import { CongratulationsCard } from './CongratulationsCard';
import type { CategoryType } from '../../types';

export const Dashboard: React.FC = () => {
    const { user } = useAuth();
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [todayTotal, setTodayTotal] = useState(0);
    const [weekTotal, setWeekTotal] = useState(0);
    const [monthTotal, setMonthTotal] = useState(0);
    const [topCategory, setTopCategory] = useState<{ category: CategoryType; total: number } | null>(null);
    const [categoryData, setCategoryData] = useState<{ category: CategoryType; total: number; count: number }[]>([]);
    const [trendData, setTrendData] = useState<{ date: string; amount: number }[]>([]);
    const [previousWeekTotal, setPreviousWeekTotal] = useState(0);
    const [previousMonthTotal, setPreviousMonthTotal] = useState(0);

    useEffect(() => {
        if (user) {
            loadSummary();
        }
    }, [user]);

    const loadSummary = async () => {
        if (!user) return;

        try {
            const [today, week, month, top, categories, trend, prevWeek, prevMonth] = await Promise.all([
                getTodayTotal(user.id),
                getWeekTotal(user.id),
                getMonthTotal(user.id),
                getTopCategory(user.id, 'month'),
                getCategoryBreakdown(user.id, 'month'),
                getTrendData(user.id, 'month'),
                getPreviousWeekTotal(user.id),
                getPreviousMonthTotal(user.id),
            ]);

            setTodayTotal(today);
            setWeekTotal(week);
            setMonthTotal(month);
            setTopCategory(top);
            setCategoryData(categories);
            setTrendData(trend);
            setPreviousWeekTotal(prevWeek);
            setPreviousMonthTotal(prevMonth);
        } catch (error) {
            console.error('Failed to load summary:', error);
        }
    };

    return (
        <div className="min-h-screen bg-gradient-to-br from-neutral-50 via-primary-50/30 to-neutral-50 dark:from-neutral-950 dark:via-primary-950/20 dark:to-neutral-900">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                {/* Congratulations Cards */}
                {weekTotal > 0 && previousWeekTotal > 0 && weekTotal < previousWeekTotal && (
                    <CongratulationsCard
                        type="week"
                        currentAmount={weekTotal}
                        previousAmount={previousWeekTotal}
                        savings={previousWeekTotal - weekTotal}
                        savingsPercentage={((previousWeekTotal - weekTotal) / previousWeekTotal) * 100}
                    />
                )}
                {monthTotal > 0 && previousMonthTotal > 0 && monthTotal < previousMonthTotal && (
                    <CongratulationsCard
                        type="month"
                        currentAmount={monthTotal}
                        previousAmount={previousMonthTotal}
                        savings={previousMonthTotal - monthTotal}
                        savingsPercentage={((previousMonthTotal - monthTotal) / previousMonthTotal) * 100}
                    />
                )}

                {/* Summary Cards */}
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <SummaryCard title="Today" amount={todayTotal} index={0} />
                    <SummaryCard title="This Week" amount={weekTotal} index={1} />
                    <SummaryCard title="This Month" amount={monthTotal} index={2} />
                    <div className="bg-gradient-to-br from-amber-500 to-orange-600 rounded-lg p-6 text-white shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105">
                        <h3 className="text-sm font-medium opacity-90 mb-1">
                            Top Category
                        </h3>
                        <p className="text-3xl font-bold capitalize">
                            {topCategory ? topCategory.category : '-'}
                        </p>
                        {topCategory && (
                            <p className="text-sm opacity-90 mt-2">
                                {formatCurrency(topCategory.total)}
                                isOpen={isModalOpen}
                                onClose={() => setIsModalOpen(false)}
                                onSuccess={loadSummary}
                />
                            </div>
        </div>
                    );
};

                    const SummaryCard: React.FC<{ title: string; amount: number; index?: number }> = ({title, amount, index = 0}) => {
    const gradients = [
                    'from-blue-500 to-blue-600',
                    'from-purple-500 to-purple-600',
                    'from-pink-500 to-pink-600',
                    'from-emerald-500 to-emerald-600',
                    ];

                    const gradient = gradients[index % gradients.length];

                    return (
                    <div className={`bg-gradient-to-br ${gradient} rounded-lg p-6 text-white shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-105`}>
                        <h3 className="text-sm font-medium opacity-90 mb-1">
                            {title}
                        </h3>
                        <p className="text-3xl font-bold">
                            {formatCurrency(amount)}
                        </p>
                        <div className="mt-2 h-1 bg-white/20 rounded-full">
                            <div className="h-full bg-white/40 rounded-full" style={{ width: '70%' }}></div>
                        </div>
                    </div>
                    );
};

                    const AddExpenseModal: React.FC<{
    isOpen: boolean;
    onClose: () => void;
    onSuccess: () => void;
}> = ({isOpen, onClose, onSuccess}) => {
    const {user} = useAuth();
                    const [amount, setAmount] = useState('');
                    const [category, setCategory] = useState<CategoryType>('food');
                        const [notes, setNotes] = useState('');
                        const [date, setDate] = useState(new Date()); // Date object instead of string
                        const [loading, setLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
                            e.preventDefault();
                        if (!user || !amount) return;

                        setLoading(true);
                        try {
            const {addExpense} = await import('../../lib/db/expenseStore');
                        // Use the selected date with current time
                        const dateTime = new Date(
                        date.getFullYear(),
                        date.getMonth(),
                        date.getDate(),
                        new Date().getHours(),
                        new Date().getMinutes(),
                        new Date().getSeconds()
                        ).toISOString();

                        await addExpense(
                        user.id,
                        parseFloat(amount),
                        category,
                        dateTime,
                        notes
                        );

                        setAmount('');
                        setNotes('');
                        setDate(new Date()); // Reset to today
                        onSuccess();
                        onClose();
        } catch (error) {
                            console.error('Failed to add expense:', error);
        } finally {
                            setLoading(false);
        }
    };

                        return (
                        <Modal isOpen={isOpen} onClose={onClose} title="Add Expense">
                            <form onSubmit={handleSubmit} className="space-y-4">
                                <Input
                                    label="Amount"
                                    type="number"
                                    step="0.01"
                                    value={amount}
                                    onChange={(e) => setAmount(e.target.value)}
                                    placeholder="0.00"
                                    required
                                />

                                <DatePickerInput
                                    label="Date"
                                    selected={date}
                                    onChange={(newDate) => setDate(newDate)}
                                    maxDate={new Date()}
                                    required
                                />

                                <div>
                                    <label className="block text-sm font-medium text-neutral-700 dark:text-neutral-300 mb-1">
                                        Category
                                    </label>
                                    <select
                                        value={category}
                                        onChange={(e) => setCategory(e.target.value as CategoryType)}
                                        className="w-full px-3 py-2 border rounded-md bg-white dark:bg-neutral-800 border-neutral-300 dark:border-neutral-600 text-neutral-900 dark:text-neutral-100"
                                    >
                                        <option value="food">üçî Food</option>
                                        <option value="travel">üöó Travel</option>
                                        <option value="bills">üí° Bills</option>
                                        <option value="shopping">üõçÔ∏è Shopping</option>
                                        <option value="entertainment">üé¨ Entertainment</option>
                                        <option value="health">üíä Health</option>
                                        <option value="custom">‚úèÔ∏è Custom</option>
                                    </select>
                                </div>

                                <Input
                                    label="Notes (optional)"
                                    value={notes}
                                    onChange={(e) => setNotes(e.target.value)}
                                    placeholder="Add notes..."
                                />

                                <div className="flex gap-3 pt-4">
                                    <Button type="button" variant="ghost" onClick={onClose} className="flex-1">
                                        Cancel
                                    </Button>
                                    <Button type="submit" loading={loading} className="flex-1">
                                        Save
                                    </Button>
                                </div>
                            </form>
                        </Modal>
                        );
};
